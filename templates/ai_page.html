{% extends 'base.html' %}
{% block content %}
<div class="ai-container">
    <div class="container">
        <div class="ai-header">
            <h1 class="ai-title">AI 对话（DeepSeek）</h1>
            <p class="ai-subtitle">与AI进行智能对话，获取专业回答</p>
        </div>
        
        <div class="ai-card">
            <form action="{{ url_for('ai_page') }}" method="post" class="ai-form" data-no-loading="true">

                <div class="form-section">
                    <h2 class="section-title">AI功能选择</h2>
                    
                    <div class="form-row">
                        <div class="form-group full">
                            <label for="ai_function" class="form-label">选择AI功能</label>
                            <select id="ai_function" name="ai_function" class="form-select">
                                <option value="chat">智能对话</option>
                                <option value="file_analysis">文件内容分析</option>
                                <option value="smart_categorization">智能分类</option>
                                <option value="text_summarization">文本摘要</option>
                                <option value="code_explanation">代码解释</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h2 class="section-title">输入内容</h2>
                    
                    <div class="form-group">
                        <label for="prompt" class="form-label">问题/文本/文件内容</label>
                        <textarea id="prompt" name="prompt" rows="5" placeholder="在此输入您的问题、文本内容或粘贴文件内容" class="form-textarea" required></textarea>
                        <p class="form-hint">
                            • 智能对话：直接输入您的问题<br>
                            • 文件内容分析：粘贴文件内容，描述您想分析的内容<br>
                            • 智能分类：输入内容，让AI自动分类<br>
                            • 文本摘要：输入长文本，获取摘要<br>
                            • 代码解释：输入代码，获取详细解释
                        </p>
                    </div>
                </div>
                
                <div class="form-section">
                    <h2 class="section-title">AI设置</h2>
                    
                    <div class="form-row">
                        <div class="form-group half">
                            <label for="model" class="form-label">AI模型</label>
                            <select id="model" name="model" class="form-select">
                                <option value="deepseek-chat">DeepSeek Chat</option>
                            </select>
                        </div>
                        <div class="form-group half">
                            <label for="temperature" class="form-label">生成温度</label>
                            <select id="temperature" name="temperature" class="form-select">
                                <option value="0.3">精确 (0.3)</option>
                                <option value="0.5" selected>平衡 (0.5)</option>
                                <option value="0.7">灵活 (0.7)</option>
                                <option value="1.0">创意 (1.0)</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <a href="{{ url_for('index') }}" class="btn btn-cancel">取消</a>
                    <button type="submit" class="btn btn-primary btn-submit">
                        <span class="btn-icon">🤖</span>
                        发送请求
                    </button>
                </div>
            </form>
            
            {% if ai_error %}
                <div class="error-message">
                    <h3 class="error-title">请求失败</h3>
                    <p class="error-text">{{ ai_error }}</p>
                </div>
            {% endif %}
            
            {% if ai_output %}
                <div class="response-section">
                    <h2 class="section-title">AI回复</h2>
                    <div class="response-header">
                        <form action="{{ url_for('save_ai_content') }}" method="post" class="save-form">

                            <input type="hidden" name="ai_function" value="{{ request.form.get('ai_function', 'chat') }}">
                            <input type="hidden" name="prompt" value="{{ request.form.get('prompt') }}">
                            <input type="hidden" name="response" value="{{ ai_output }}">
                            <button type="submit" class="btn btn-secondary">
                                <span class="btn-icon">💾</span>
                                保存回复
                            </button>
                        </form>
                    </div>
                    <div class="ai-output">
                        {{ ai_output }}
                    </div>
                </div>
            {% endif %}
            
            <!-- AI内容管理区域 -->
            <div class="ai-management">
                <h2 class="section-title">AI内容管理</h2>
                
                {% if saved_contents %}
                    <div class="saved-contents-grid">
                        {% for content in saved_contents %}
                            <div class="saved-content-card">
                                <div class="content-header">
                                    <div class="content-function">{{ content.ai_function }}</div>
                                    <div class="content-date">{{ content.created_at }}</div>
                                </div>
                                <div class="content-prompt">
                                    <strong>问题：</strong>{{ content.prompt[:100] }}{% if content.prompt|length > 100 %}...{% endif %}
                                </div>
                                <div class="content-response">
                                    <strong>回复：</strong>{{ content.response[:150] }}{% if content.response|length > 150 %}...{% endif %}
                                </div>
                                <div class="content-actions">
                                    <button class="btn btn-sm btn-primary view-content" data-id="{{ content.id }}">
                                        <span class="btn-icon">👁️</span>
                                        查看
                                    </button>
                                    <form action="{{ url_for('delete_ai_content') }}" method="post" style="display: inline;">

                                        <input type="hidden" name="content_id" value="{{ content.id }}">
                                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('确定要删除这条内容吗？')">
                                            <span class="btn-icon">🗑️</span>
                                            删除
                                        </button>
                                    </form>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">📝</div>
                        <p>您还没有保存任何AI生成的内容</p>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <div class="ai-features">
            <h2 class="features-title">AI对话的优势</h2>
            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-icon">💡</div>
                    <h3 class="feature-title">智能回答</h3>
                    <p class="feature-desc">基于DeepSeek强大的AI模型，提供准确、专业的回答</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">⚡</div>
                    <h3 class="feature-title">快速响应</h3>
                    <p class="feature-desc">实时处理您的问题，快速返回结果</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">📚</div>
                    <h3 class="feature-title">知识渊博</h3>
                    <p class="feature-desc">涵盖广泛的知识领域，解答各类问题</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">🔒</div>
                    <h3 class="feature-title">安全可靠</h3>
                    <p class="feature-desc">保护您的隐私，确保对话内容安全</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="app-data" data-is-logged-in="{{ session.user_id is not none | tojson | safe }}" class="hidden"></div>
<link rel="stylesheet" href="{{ url_for('static', filename='ai.css') }}">
<script>
  // AI请求表单提交处理
  document.addEventListener('DOMContentLoaded', function() {
    const aiForm = document.querySelector('.ai-form');
    
    aiForm.addEventListener('submit', function(e) {
      // 显示加载动画
      showLoading();
      
      // 表单提交成功后隐藏加载动画
      setTimeout(() => {
        hideLoading();
      }, 1000);
    });
    
    // 保存回复表单提交处理
    const saveForms = document.querySelectorAll('.save-form');
    saveForms.forEach(form => {
      form.addEventListener('submit', function(e) {
        // 显示加载动画
        showLoading();
        
        // 表单提交成功后隐藏加载动画并显示成功提示
        setTimeout(() => {
          hideLoading();
          showToast('回复保存成功', 'success');
        }, 500);
      });
    });
  });
</script>
{% endblock %}