{% extends 'base.html' %}
{% block content %}
<div class="grid-three full-width">
  <section id="upload" class="card card-lg">
    <div class="card-head">
      <div class="card-title">文件上传</div>
    </div>
    <div class="card-body">
      <form class="upload-form" action="{{ url_for('upload') }}" method="post" enctype="multipart/form-data" {% if not session.user_id %}onsubmit="alert('请先登录，才能使用文件上传功能'); return false;"{% endif %}>
        <div class="form-row">
          <label class="form-label">项目名称</label>
          <input class="input" type="text" name="project_name" value="默认项目" placeholder="默认项目">
        </div>
        <div class="form-row">
          <label class="form-label">项目描述</label>
          <textarea class="textarea" name="project_desc" placeholder="输入项目描述（可选）"></textarea>
        </div>
        <input id="file-input" type="file" name="file" required hidden>
        <label class="upload-zone" for="file-input">
          <div class="upload-icon">⬆️</div>
          <div class="upload-cta">拖放文件到此处，或点击整个区域选择文件</div>
          <div class="upload-sub"><button type="button" class="btn btn-light browse-btn">浏览文件</button></div>
          <div id="selected-file" class="selected-file"></div>
        </label>
        <div class="actions">
          <button class="btn btn-upload" type="submit">
            <svg class="btn-ico" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M3 11l18-7-8 18-2-7-8-4z" fill="currentColor"/>
            </svg>
            上传文件
          </button>
        </div>
      </form>
    </div>
  </section>

  <section id="local" class="card card-lg">
    <div class="card-head">
      <div class="card-title">文件列表</div>
    </div>
    <div class="card-body">
      {% if files %}
        <div class="file-list">
          {% for f in files %}
          {% set d = (f.dkfile or {}).get('data') %}
          <div class="file-card">
            <div class="file-head">
              <div class="file-name">{{ f.filename }}</div>
              <div class="meta-item">大小：<strong>{{ (f.size or 0) | int }} B</strong></div>
            </div>
            <div class="file-meta">
              <div class="meta-item">项目名称：<strong>{{ f.project_name or '-' }}</strong></div>
              <div class="meta-item">项目描述：<strong>{{ f.project_desc or '-' }}</strong></div>
              <div class="meta-item">远端链接：<strong>{% if d and d.url %}<a href="{{ d.url }}" target="_blank">打开</a>{% else %}-{% endif %}</strong></div>
              <div class="meta-item">创建时间：<strong>{{ d and d.created_at or '-' }}</strong></div>
              <div class="meta-item">更新时间：<strong>{{ d and d.updated_at or '-' }}</strong></div>
            </div>
            <div class="file-actions">
              <a class="btn file-action" href="{{ url_for('file_detail', file_id=f.id) }}">详情</a>
              <a class="btn file-action" href="{{ url_for('download_local', stored_name=f.stored_name) }}">下载</a>
              <form class="inline" action="{{ url_for('file_delete', file_id=f.id) }}" method="post">
                <button class="btn danger file-action" type="submit">删除</button>
              </form>
            </div>
          </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="empty-placeholder">
          <div class="empty-icon">☁️</div>
          <div class="empty-title">暂无文件</div>
          {% if session.user_id %}
            <div class="empty-desc">上传您的第一个文件开始使用</div>
          {% else %}
            <div class="empty-desc">请先登录，查看和管理您的文件</div>
            <div class="auth-required-actions" style="margin-top: 16px;">
              <a href="{{ url_for('login') }}" class="btn btn-primary">登录</a>
              <a href="{{ url_for('register') }}" class="btn btn-light">注册</a>
            </div>
          {% endif %}
        </div>
      {% endif %}
    </div>
  </section>

  <section id="ai" class="card card-lg">
    <div class="card-head">
      <div class="card-title">AI 对话（DeepSeek）</div>
    </div>
    <div class="card-body">
      <form action="{{ url_for('ai') }}" method="post" {% if not session.user_id %}onsubmit="alert('请先登录，才能使用AI对话功能'); return false;"{% endif %}>
        <div class="form-row">
          <label class="form-label">问题</label>
          <textarea class="textarea" name="prompt" placeholder="在此输入你的问题"></textarea>
        </div>
        <div class="actions">
          <button class="btn btn-primary" type="submit">发送到 DeepSeek</button>
        </div>
      </form>
      {% if ai_error %}
        <div class="error" style="margin-top:10px">请求失败：{{ ai_error }}</div>
      {% endif %}
      {% if ai_output %}
        <div class="section-title" style="margin-top:16px">回复</div>
        <div class="ai-output">{{ ai_output }}</div>
      {% endif %}
    </div>
  </section>
</div>

<section id="remote" class="card">
  <div class="card-head">
    <div class="card-title">DKFile 远端文件</div>
  </div>
  <div class="card-body">
    {% if remote_table and remote_table|length > 0 %}
      <table class="table">
        <thead>
          <tr>
            <th>文件名</th>
            <th>URL</th>
            <th>创建时间</th>
            <th>更新</th>
          </tr>
        </thead>
        <tbody>
          {% for r in remote_table %}
          <tr>
            <td>{{ r.file_name }}</td>
            <td><a href="{{ r.url }}" target="_blank">访问</a></td>
            <td>{{ r.created_at or '-' }}</td>
            <td>{{ r.is_update and '是' or '否' }}{% if r.updated_at %}（{{ r.updated_at }}）{% endif %}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      {% if remote_error %}
        <div class="error">请求失败：{{ remote_error }}</div>
      {% else %}
        <div class="empty">暂无上传记录</div>
      {% endif %}
    {% endif %}
  </div>
</section>

<div id="app-data" data-is-logged-in="{{ session.user_id is not none | tojson | safe }}" style="display: none;"></div>

<script>
const zone = document.querySelector('.upload-zone');
const input = document.getElementById('file-input');
const selected = document.getElementById('selected-file');
const browseBtn = document.querySelector('.browse-btn');
const fileActions = document.querySelectorAll('.file-action');
const uploadForm = document.querySelector('.upload-form');
const appData = document.getElementById('app-data');

// 检查用户是否登录
const isLoggedIn = JSON.parse(appData.dataset.isLoggedIn);

function showName() {
  selected.textContent = input.files && input.files[0] ? input.files[0].name : '';
}

// 浏览文件按钮点击事件
browseBtn.addEventListener('click', () => {
  if (isLoggedIn) {
    document.getElementById('file-input').click();
  } else {
    alert('请先登录，才能使用文件上传功能');
  }
});

// 文件输入变化事件
input.addEventListener('change', (e) => {
  if (!isLoggedIn) {
    alert('请先登录，才能使用文件上传功能');
    e.target.value = '';
    return;
  }
  showName();
});

// 上传表单提交事件
uploadForm.addEventListener('submit', (e) => {
  if (!isLoggedIn) {
    alert('请先登录，才能使用文件上传功能');
    e.preventDefault();
    return;
  }
});

// 拖拽事件处理
zone.addEventListener('dragover', e => {
  e.preventDefault();
  zone.classList.add('drag');
});

zone.addEventListener('dragleave', e => {
  e.preventDefault();
  zone.classList.remove('drag');
});

zone.addEventListener('drop', e => {
  e.preventDefault();
  zone.classList.remove('drag');
  
  if (!isLoggedIn) {
    alert('请先登录，才能使用文件上传功能');
    return;
  }
  
  const dt = new DataTransfer();
  if (e.dataTransfer.files.length) {
    dt.items.add(e.dataTransfer.files[0]);
    input.files = dt.files;
    showName();
  }
});

// 处理文件操作事件
fileActions.forEach(action => {
  if (action.tagName === 'A') {
    // 处理链接点击
    action.addEventListener('click', (e) => {
      if (!isLoggedIn) {
        alert('请先登录，才能执行此操作');
        e.preventDefault();
        return;
      }
    });
  } else if (action.tagName === 'BUTTON') {
    // 处理按钮点击
    action.addEventListener('click', (e) => {
      if (!isLoggedIn) {
        alert('请先登录，才能执行此操作');
        e.preventDefault();
        return;
      }
      
      // 如果是删除按钮，显示确认对话框
      if (action.textContent.trim() === '删除') {
        if (!confirm('确定要删除这个文件吗？此操作不可恢复。')) {
          e.preventDefault();
        }
      }
    });
  }
});
</script>
{% endblock %}
