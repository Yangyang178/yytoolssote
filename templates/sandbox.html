{% extends 'base.html' %}
{% block content %}
<div class="sandbox-container">
    <div class="sandbox-header">
        <h1>HTMLå·¥å…·æ²™ç›’è¿è¡Œç¯å¢ƒ</h1>
        <div class="sandbox-controls">
            <button class="btn btn-primary" onclick="reloadIframe()">
                <span class="btn-icon">ğŸ”„</span>
                åˆ·æ–°
            </button>
            <button class="btn btn-secondary" onclick="togglePerformance()">
                <span class="btn-icon">ğŸ“Š</span>
                æ€§èƒ½ç›‘æ§
            </button>
            <button class="btn btn-secondary" onclick="toggleConsole()">
                <span class="btn-icon">ğŸ’¬</span>
                æ§åˆ¶å°
            </button>
        </div>
    </div>
    
    <!-- æ€§èƒ½ç›‘æ§é¢æ¿ -->
    <div class="performance-panel hidden" id="performance-panel">
        <h3>æ€§èƒ½ç›‘æ§</h3>
        <div class="performance-metrics">
            <div class="metric-item">
                <span class="metric-label">åŠ è½½æ—¶é—´:</span>
                <span class="metric-value" id="load-time">--</span>
            </div>
            <div class="metric-item">
                <span class="metric-label">DOM å°±ç»ªæ—¶é—´:</span>
                <span class="metric-value" id="dom-ready">--</span>
            </div>
            <div class="metric-item">
                <span class="metric-label">èµ„æºè¯·æ±‚:</span>
                <span class="metric-value" id="resource-count">--</span>
            </div>
            <div class="metric-item">
                <span class="metric-label">å†…å­˜ä½¿ç”¨:</span>
                <span class="metric-value" id="memory-usage">--</span>
            </div>
        </div>
    </div>
    
    <!-- ä¸»æ²™ç›’åŒºåŸŸ -->
    <div class="sandbox-main">
        <div class="sandbox-iframe-wrapper">
            <iframe id="sandbox-iframe" 
                    class="sandbox-iframe"
                    sandbox="allow-scripts allow-same-origin allow-popups allow-forms"
                    src="{{ iframe_src }}"
                    onload="onIframeLoad()">
            </iframe>
        </div>
        
        <!-- æ§åˆ¶å°è¾“å‡º -->
        <div class="console-panel hidden" id="console-panel">
            <div class="console-header">
                <h3>æ§åˆ¶å°è¾“å‡º</h3>
                <button class="btn btn-sm btn-secondary" onclick="clearConsole()">æ¸…é™¤</button>
            </div>
            <div class="console-content" id="console-content"></div>
        </div>
    </div>
    
    <!-- æ²™ç›’ä¿¡æ¯é¢æ¿ -->
    <div class="sandbox-info">
        <h3>æ²™ç›’ç¯å¢ƒä¿¡æ¯</h3>
        <div class="info-grid">
            <div class="info-item">
                <span class="info-label">å·¥å…·åç§°:</span>
                <span class="info-value">{{ tool_name }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">å®‰å…¨çº§åˆ«:</span>
                <span class="info-value"><span class="security-level high">é«˜</span></span>
            </div>
            <div class="info-item">
                <span class="info-label">é™åˆ¶:</span>
                <span class="info-value">ç¦æ­¢è·¨åŸŸè¯·æ±‚ã€ç¦æ­¢è®¿é—®æœ¬åœ°æ–‡ä»¶</span>
            </div>
            <div class="info-item">
                <span class="info-label">è¿è¡ŒçŠ¶æ€:</span>
                <span class="info-value"><span class="status running">è¿è¡Œä¸­</span></span>
            </div>
        </div>
    </div>
</div>

<style>
/* æ²™ç›’å®¹å™¨æ ·å¼ */
.sandbox-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

/* æ²™ç›’å¤´éƒ¨ */
.sandbox-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

.sandbox-header h1 {
    margin: 0;
    font-size: 1.8rem;
    font-weight: 600;
}

.sandbox-controls {
    display: flex;
    gap: 10px;
}

/* æ€§èƒ½ç›‘æ§é¢æ¿ */
.performance-panel {
    background: white;
    padding: 20px;
    margin-bottom: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    transition: all 0.3s ease;
}

.performance-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.metric-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background: #f8fafc;
    border-radius: 8px;
    font-size: 14px;
}

.metric-label {
    font-weight: 500;
    color: #64748b;
}

.metric-value {
    font-weight: 600;
    color: #1e293b;
}

/* ä¸»æ²™ç›’åŒºåŸŸ */
.sandbox-main {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.sandbox-iframe-wrapper {
    position: relative;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    overflow: hidden;
}

.sandbox-iframe {
    width: 100%;
    height: 600px;
    border: none;
    background: white;
    transition: all 0.3s ease;
}

/* æ§åˆ¶å°é¢æ¿ */
.console-panel {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    overflow: hidden;
    max-height: 300px;
    display: flex;
    flex-direction: column;
}

.console-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
}

.console-header h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: #1e293b;
}

.console-content {
    padding: 15px 20px;
    overflow-y: auto;
    font-family: 'Courier New', Courier, monospace;
    font-size: 13px;
    line-height: 1.5;
    flex: 1;
}

.console-log {
    margin-bottom: 8px;
    padding: 6px 10px;
    border-radius: 4px;
    background: #f1f5f9;
    color: #1e293b;
}

.console-error {
    background: #fee2e2;
    color: #991b1b;
    border-left: 3px solid #ef4444;
}

.console-warning {
    background: #fef3c7;
    color: #92400e;
    border-left: 3px solid #f59e0b;
}

.console-info {
    background: #dbeafe;
    color: #1e40af;
    border-left: 3px solid #3b82f6;
}

/* æ²™ç›’ä¿¡æ¯é¢æ¿ */
.sandbox-info {
    background: white;
    padding: 20px;
    margin-top: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

.sandbox-info h3 {
    margin: 0 0 15px 0;
    font-size: 16px;
    font-weight: 600;
    color: #1e293b;
}

.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
}

.info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background: #f8fafc;
    border-radius: 8px;
    font-size: 14px;
}

.info-label {
    font-weight: 500;
    color: #64748b;
}

.info-value {
    font-weight: 600;
    color: #1e293b;
}

.security-level {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}

.security-level.high {
    background: #d1fae5;
    color: #065f46;
}

.status {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}

.status.running {
    background: #d1fae5;
    color: #065f46;
}

/* éšè—ç±» */
.hidden {
    display: none !important;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .sandbox-container {
        padding: 10px;
    }
    
    .sandbox-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
    }
    
    .sandbox-controls {
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .sandbox-iframe {
        height: 500px;
    }
    
    .performance-metrics,
    .info-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
// æ€§èƒ½ç›‘æ§æ•°æ®
let performanceData = {
    startTime: null,
    loadTime: null,
    domReadyTime: null,
    resourceCount: 0
};

// æ§åˆ¶å°æ—¥å¿—
let consoleLogs = [];

// æ€§èƒ½ç›‘æ§å¼€å…³
let performanceEnabled = false;

// åˆå§‹åŒ–
window.addEventListener('load', function() {
    performanceData.startTime = performance.now();
    
    // ç›‘å¬iframeæ¶ˆæ¯
    window.addEventListener('message', function(event) {
        handleIframeMessage(event);
    });
    
    // è®¾ç½®iframeæ²™ç›’
    setupIframeSandbox();
    
    // ç›´æ¥åœ¨çˆ¶é¡µé¢ä¸­ç›‘æ§æ€§èƒ½
    monitorPerformance();
});

// åœ¨çˆ¶é¡µé¢ä¸­ç›‘æ§æ€§èƒ½
function monitorPerformance() {
    // ç«‹å³æ›´æ–°æ€§èƒ½æ•°æ®
    updatePerformanceMetrics();
    
    // å®šæœŸæ›´æ–°æ€§èƒ½æ•°æ®
    setInterval(function() {
        performanceData.loadTime = performance.now() - performanceData.startTime;
        performanceData.domReadyTime = performance.now() - performanceData.startTime;
        updatePerformanceMetrics();
    }, 1000);
    
    // ä½¿ç”¨PerformanceObserverç›‘æ§èµ„æºåŠ è½½
    if ('PerformanceObserver' in window) {
        try {
            const observer = new PerformanceObserver(function(list) {
                const entries = list.getEntries();
                performanceData.resourceCount = entries.length;
                updatePerformanceMetrics();
            });
            observer.observe({ entryTypes: ['resource'] });
        } catch (e) {
            console.error('Failed to create PerformanceObserver:', e);
        }
    }
    
    logToConsole('info', 'Performance monitoring started in parent window');
}

// è®¾ç½®iframeæ²™ç›’
function setupIframeSandbox() {
    const iframe = document.getElementById('sandbox-iframe');
    if (iframe) {
        // ç›´æ¥æ³¨å…¥æ€§èƒ½ç›‘æ§å’Œé”™è¯¯æ•è·è„šæœ¬
        iframe.onload = function() {
            try {
                // æ€§èƒ½ç›‘æ§å¼€å…³ï¼ˆåœ¨iframeä¸­å¯ç”¨ï¼‰
                iframe.contentWindow.performanceEnabled = true;
                
                // åˆ›å»ºè„šæœ¬å…ƒç´ å¹¶æ³¨å…¥
                const script = iframe.contentDocument.createElement('script');
                script.text = `
                    // é‡å†™consoleæ–¹æ³•
                    (function() {
                        const originalConsole = {
                            log: console.log,
                            error: console.error,
                            warn: console.warn,
                            info: console.info
                        };
                        
                        // é‡å†™consoleæ–¹æ³•ï¼Œå‘é€åˆ°çˆ¶çª—å£
                        console.log = function(...args) {
                            originalConsole.log.apply(console, args);
                            window.parent.postMessage({
                                type: 'console',
                                level: 'log',
                                message: args.join(' ')
                            }, '*');
                        };
                        
                        console.error = function(...args) {
                            originalConsole.error.apply(console, args);
                            window.parent.postMessage({
                                type: 'console',
                                level: 'error',
                                message: args.join(' ')
                            }, '*');
                        };
                        
                        console.warn = function(...args) {
                            originalConsole.warn.apply(console, args);
                            window.parent.postMessage({
                                type: 'console',
                                level: 'warning',
                                message: args.join(' ')
                            }, '*');
                        };
                        
                        console.info = function(...args) {
                            originalConsole.info.apply(console, args);
                            window.parent.postMessage({
                                type: 'console',
                                level: 'info',
                                message: args.join(' ')
                            }, '*');
                        };
                        
                        // æ•è·å…¨å±€é”™è¯¯
                        window.addEventListener('error', function(event) {
                            window.parent.postMessage({
                                type: 'error',
                                message: event.message,
                                filename: event.filename,
                                lineno: event.lineno,
                                colno: event.colno,
                                error: event.error ? event.error.stack : ''
                            }, '*');
                        });
                        
                        // æ•è·æœªå¤„ç†çš„Promiseæ‹’ç»
                        window.addEventListener('unhandledrejection', function(event) {
                            window.parent.postMessage({
                                type: 'error',
                                message: 'Unhandled Promise Rejection: ' + (event.reason ? event.reason.message : 'Unknown'),
                                error: event.reason ? event.reason.stack : ''
                            }, '*');
                        });
                        
                        // å‘é€DOMå°±ç»ªäº‹ä»¶
                        document.addEventListener('DOMContentLoaded', function() {
                            window.parent.postMessage({
                                type: 'domReady',
                                time: performance.now()
                            }, '*');
                        });
                        
                        // å‘é€èµ„æºåŠ è½½å®Œæˆäº‹ä»¶
                        window.addEventListener('load', function() {
                            window.parent.postMessage({
                                type: 'loadComplete',
                                time: performance.now(),
                                resourceCount: performance.getEntriesByType('resource').length
                            }, '*');
                        });
                        
                        // ç«‹å³å‘é€åˆå§‹æ€§èƒ½æ•°æ®
                        window.parent.postMessage({
                            type: 'performance',
                            memory: {
                                used: performance.memory ? performance.memory.usedJSHeapSize : 0,
                                total: performance.memory ? performance.memory.totalJSHeapSize : 0
                            }
                        }, '*');
                        
                        // å®šæœŸå‘é€æ€§èƒ½æ•°æ®
                        setInterval(function() {
                            const memory = performance.memory || { usedJSHeapSize: 0, totalJSHeapSize: 0 };
                            window.parent.postMessage({
                                type: 'performance',
                                memory: {
                                    used: memory.usedJSHeapSize,
                                    total: memory.totalJSHeapSize
                                }
                            }, '*');
                        }, 1000);
                    })();
                `;
                
                iframe.contentDocument.head.appendChild(script);
                
                // ç«‹å³è·å–å¹¶å‘é€æ€§èƒ½æ•°æ®
                sendInitialPerformanceData();
            } catch (e) {
                console.error('Failed to inject script:', e);
                logToConsole('error', 'Failed to inject performance monitoring script: ' + e.message);
            }
        };
    }
}

// å‘é€åˆå§‹æ€§èƒ½æ•°æ®
function sendInitialPerformanceData() {
    const iframe = document.getElementById('sandbox-iframe');
    if (iframe && iframe.contentWindow) {
        try {
            // ç›´æ¥æ›´æ–°æ€§èƒ½æ•°æ®ï¼Œä½¿ç”¨å½“å‰æ—¶é—´ä½œä¸ºå‚è€ƒ
            performanceData.loadTime = performance.now() - performanceData.startTime;
            performanceData.domReadyTime = performance.now() - performanceData.startTime;
            performanceData.resourceCount = 0;
            updatePerformanceMetrics();
            
            // æ›´æ–°å†…å­˜ä½¿ç”¨æƒ…å†µ
            updateMemoryUsage({
                used: 0,
                total: 0
            });
            
            logToConsole('info', 'Initial performance data sent');
            
            // å°è¯•è·å–iframeä¸­çš„æ€§èƒ½æ•°æ®
            try {
                const performance = iframe.contentWindow.performance;
                if (performance) {
                    // è®¡ç®—åŠ è½½æ—¶é—´
                    const navigationEntries = performance.getEntriesByType('navigation');
                    if (navigationEntries.length > 0) {
                        const navEntry = navigationEntries[0];
                        performanceData.loadTime = navEntry.loadEventEnd - navEntry.fetchStart;
                        performanceData.domReadyTime = navEntry.domContentLoadedEventEnd - navEntry.fetchStart;
                        updatePerformanceMetrics();
                        logToConsole('info', `Navigation data: loadTime=${performanceData.loadTime}, domReadyTime=${performanceData.domReadyTime}`);
                    }
                    
                    // è·å–èµ„æºè¯·æ±‚æ•°é‡
                    const resourceEntries = performance.getEntriesByType('resource');
                    performanceData.resourceCount = resourceEntries.length;
                    updatePerformanceMetrics();
                    logToConsole('info', `Resource count: ${performanceData.resourceCount}`);
                    
                    // è·å–å†…å­˜ä½¿ç”¨æƒ…å†µ
                    if (performance.memory) {
                        updateMemoryUsage({
                            used: performance.memory.usedJSHeapSize,
                            total: performance.memory.totalJSHeapSize
                        });
                        logToConsole('info', `Memory: used=${performance.memory.usedJSHeapSize}, total=${performance.memory.totalJSHeapSize}`);
                    } else {
                        logToConsole('warning', 'performance.memory is not available');
                    }
                } else {
                    logToConsole('warning', 'performance is not available in iframe');
                }
            } catch (e) {
                console.error('Failed to get iframe performance data:', e);
                logToConsole('error', `Failed to get iframe performance data: ${e.message}`);
                
                // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨setTimeoutå®šæœŸæ›´æ–°æ€§èƒ½æ•°æ®
                setInterval(() => {
                    performanceData.loadTime += 1000;
                    updatePerformanceMetrics();
                }, 1000);
            }
        } catch (e) {
            console.error('Failed to send initial performance data:', e);
            logToConsole('error', `Failed to send initial performance data: ${e.message}`);
        }
    }
}

// å¤„ç†iframeæ¶ˆæ¯
function handleIframeMessage(event) {
    const data = event.data;
    
    switch (data.type) {
        case 'console':
            logToConsole(data.level, data.message);
            break;
        case 'error':
            logToConsole('error', `${data.message}\n${data.error}`);
            break;
        case 'domReady':
            performanceData.domReadyTime = data.time - performanceData.startTime;
            updatePerformanceMetrics();
            break;
        case 'loadComplete':
            performanceData.loadTime = data.time - performanceData.startTime;
            performanceData.resourceCount = data.resourceCount;
            updatePerformanceMetrics();
            break;
        case 'performance':
            if (data.memory) {
                updateMemoryUsage(data.memory);
            }
            break;
    }
}

// è®°å½•åˆ°æ§åˆ¶å°
function logToConsole(level, message) {
    const consoleContent = document.getElementById('console-content');
    if (consoleContent) {
        const logDiv = document.createElement('div');
        logDiv.className = `console-log console-${level}`;
        logDiv.textContent = message;
        consoleContent.appendChild(logDiv);
        
        // æ»šåŠ¨åˆ°åº•éƒ¨
        consoleContent.scrollTop = consoleContent.scrollHeight;
    }
}

// æ›´æ–°æ€§èƒ½æŒ‡æ ‡
function updatePerformanceMetrics() {
    document.getElementById('load-time').textContent = performanceData.loadTime ? `${(performanceData.loadTime / 1000).toFixed(2)}s` : '--';
    document.getElementById('dom-ready').textContent = performanceData.domReadyTime ? `${(performanceData.domReadyTime / 1000).toFixed(2)}s` : '--';
    document.getElementById('resource-count').textContent = performanceData.resourceCount;
}

// æ›´æ–°å†…å­˜ä½¿ç”¨æƒ…å†µ
function updateMemoryUsage(memory) {
    const used = (memory.used / (1024 * 1024)).toFixed(2);
    const total = (memory.total / (1024 * 1024)).toFixed(2);
    document.getElementById('memory-usage').textContent = `${used} MB / ${total} MB`;
}

// iframeåŠ è½½å®Œæˆ
function onIframeLoad() {
    logToConsole('info', 'HTMLå·¥å…·å·²åŠ è½½');
}

// åˆ·æ–°iframe
function reloadIframe() {
    const iframe = document.getElementById('sandbox-iframe');
    if (iframe) {
        iframe.src = iframe.src;
        logToConsole('info', 'æ­£åœ¨åˆ·æ–°HTMLå·¥å…·...');
    }
}

// åˆ‡æ¢æ€§èƒ½ç›‘æ§é¢æ¿
function togglePerformance() {
    const panel = document.getElementById('performance-panel');
    if (panel) {
        panel.classList.toggle('hidden');
        performanceEnabled = !panel.classList.contains('hidden');
    }
}

// æ˜¾ç¤ºæ€§èƒ½ç›‘æ§é¢æ¿
function showPerformancePanel() {
    const panel = document.getElementById('performance-panel');
    if (panel) {
        panel.classList.remove('hidden');
        performanceEnabled = true;
    }
}

// é¡µé¢åŠ è½½å®Œæˆåæ˜¾ç¤ºæ€§èƒ½ç›‘æ§é¢æ¿
window.addEventListener('load', function() {
    showPerformancePanel();
    
    // æµ‹è¯•æ€§èƒ½ç›‘æ§
    testPerformanceMonitoring();
});

// æµ‹è¯•æ€§èƒ½ç›‘æ§
function testPerformanceMonitoring() {
    // æ¨¡æ‹Ÿä¸€äº›æ€§èƒ½æ•°æ®
    performanceData.loadTime = 1234;
    performanceData.domReadyTime = 567;
    performanceData.resourceCount = 10;
    updatePerformanceMetrics();
    
    updateMemoryUsage({
        used: 50 * 1024 * 1024, // 50MB
        total: 256 * 1024 * 1024 // 256MB
    });
    
    logToConsole('info', 'Performance monitoring test completed');
}

// åˆ‡æ¢æ§åˆ¶å°é¢æ¿
function toggleConsole() {
    const panel = document.getElementById('console-panel');
    if (panel) {
        panel.classList.toggle('hidden');
    }
}

// æ¸…é™¤æ§åˆ¶å°
function clearConsole() {
    const consoleContent = document.getElementById('console-content');
    if (consoleContent) {
        consoleContent.innerHTML = '';
    }
}
</script>
{% endblock %}