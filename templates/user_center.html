{% extends 'base.html' %}
{% block content %}
<div class="user-center-container">
    <div class="container">
        <div class="page-header">
            <h1 class="page-title">ç”¨æˆ·ä¸­å¿ƒ</h1>
        </div>
        
        {% if user %}
            <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
            <div class="user-profile-card">
                <div class="profile-header">
                    <div class="profile-info">
                        <div class="avatar-section">
                            <div class="user-avatar">
                                {% if user.avatar %}
                                    <img src="{{ url_for('static', filename='avatars/' + user.avatar) }}" alt="ç”¨æˆ·å¤´åƒ" class="avatar-image">
                                {% else %}
                                    <div class="avatar-icon">{{ user.username[0] | upper }}</div>
                                {% endif %}
                            </div>
                            <div class="profile-details">
                                <h2 class="user-name">{{ user.username }}</h2>
                                <p class="user-email">{{ user.email }}</p>
                            </div>
                        </div>
                        <div class="profile-stats">
                            <div class="stat-item">
                                <span class="stat-number">{{ files | length }}</span>
                                <span class="stat-label">ä¸Šä¼ æ–‡ä»¶</span>
                            </div>
                        </div>
                    </div>
                    <div class="profile-actions">
                        <button class="btn btn-edit" id="edit-profile-btn">
                            <i class="icon-edit">âœï¸</i> ç¼–è¾‘èµ„æ–™
                        </button>
                        <a href="{{ url_for('account_settings') }}" class="btn btn-account">
                            <i class="icon-account">âš™ï¸</i> è´¦æˆ·è®¾ç½®
                        </a>
                        <a href="#" class="btn btn-logout" id="logout-btn">
                            <i class="icon-logout">ğŸšª</i> é€€å‡ºç™»å½•
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- ç¼–è¾‘èµ„æ–™æ¨¡æ€æ¡† -->
            <div id="edit-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <span class="modal-icon">ğŸ‘¤</span>
                            ç¼–è¾‘ä¸ªäººèµ„æ–™
                        </h3>
                        <button class="modal-close" id="close-modal-btn">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form action="{{ url_for('update_profile') }}" method="post" enctype="multipart/form-data">
                            <div class="form-section">
                                <!-- æ˜µç§°è¾“å…¥ -->
                                <div class="form-group">
                                    <label for="username" class="form-label">æ˜µç§°</label>
                                    <input type="text" id="username" name="username" value="{{ user.username }}" 
                                           class="form-input" required placeholder="è¯·è¾“å…¥æ‚¨çš„æ˜µç§°">
                                </div>
                                
                                <!-- å¤´åƒä¸Šä¼  -->
                                <div class="form-group">
                                    <label for="avatar" class="form-label">å¤´åƒ</label>
                                    <div class="avatar-upload-section">
                                        <div class="avatar-preview">
                                            {% if user.avatar_url %}
                                                <img id="avatar-preview-img" src="{{ user.avatar_url }}" alt="å½“å‰å¤´åƒ">
                                            {% else %}
                                                <div id="avatar-preview-placeholder" class="avatar-preview-placeholder">
                                                    <span class="placeholder-icon">ğŸ‘¤</span>
                                                    <span class="placeholder-text">æš‚æ— å¤´åƒ</span>
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="modern-file-upload">
                                            <input type="file" id="avatar" name="avatar" accept="image/jpeg,image/png" 
                                                   class="file-input">
                                            <label for="avatar" class="file-label">
                                                <div class="upload-icon">ğŸ“</div>
                                                <div class="upload-info">
                                                    <span class="upload-text">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</span>
                                                    <span class="upload-hint">æ”¯æŒJPGã€PNGæ ¼å¼ï¼Œå¤§å°ä¸è¶…è¿‡2MB</span>
                                                    <span class="file-size" id="avatar-file-size"></span>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="modal-footer">
                                <button type="button" class="btn btn-cancel" id="cancel-edit-btn">å–æ¶ˆ</button>
                                <button type="submit" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- å†…å®¹åŒºåŸŸ -->
            <div class="content-wrapper">
                <!-- æˆ‘çš„æ–‡ä»¶ -->
                <section class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">æˆ‘çš„æ–‡ä»¶</h2>
                        <div class="search-container">
                            <div class="search-input-wrapper">
                                <span class="search-icon">ğŸ”</span>
                                <input type="text" id="file-search" placeholder="æœç´¢æ–‡ä»¶..." class="search-input">
                                <button class="search-clear-btn" id="search-clear-btn">&times;</button>
                            </div>
                            <button class="search-btn">æœç´¢</button>
                        </div>
                        <a href="{{ url_for('upload_page') }}" class="btn btn-primary">
                            <i class="icon-upload">ğŸ“¤</i> ä¸Šä¼ æ–°æ–‡ä»¶
                        </a>
                    </div>
                    <div class="search-results-info" id="search-results-info"></div>
                    
                    {% if files %}
                        <div class="files-grid">
                            {% for f in files %}
                            {% set d = (f.dkfile or {}).get('data') %}
                            <div class="user-file-card" data-search="{{ f.filename }} {{ f.project_name or '' }} {{ f.project_desc or '' }} {% for category in f.categories %}{{ category.name }} {% endfor %} {% for tag in f.tags %}{{ tag.name }} {% endfor %}">
                                <div class="file-name-large">{{ f.filename }}</div>
                                <div class="file-size-info">{{ (f.size or 0) | int }} B</div>
                                <div class="file-metadata">
                                    <div class="metadata-item">
                                        <span class="metadata-label">é¡¹ç›®åç§°ï¼š</span>
                                        <span class="metadata-value">{{ f.project_name or '-' }}</span>
                                    </div>
                                    <div class="metadata-item">
                                        <span class="metadata-label">é¡¹ç›®æè¿°ï¼š</span>
                                        <span class="metadata-value">{{ f.project_desc or '-' }}</span>
                                    </div>
                                    <div class="metadata-item">
                                        <span class="metadata-label">è¿œç«¯é“¾æ¥ï¼š</span>
                                        <span class="metadata-value">{% if d and d.url %}<a href="{{ d.url }}" target="_blank">æ‰“å¼€</a>{% else %}-{% endif %}</span>
                                    </div>
                                    <div class="metadata-item">
                                        <span class="metadata-label">åˆ›å»ºæ—¶é—´ï¼š</span>
                                        <span class="metadata-value">{{ d and d.created_at or '-' }}</span>
                                    </div>
                                    {% if f.categories %}
                                    <div class="metadata-item">
                                        <span class="metadata-label">åˆ†ç±»ï¼š</span>
                                        <div class="categories-list">
                                            {% for category in f.categories %}
                                            <span class="category-tag">{{ category.name }}</span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if f.tags %}
                                    <div class="metadata-item">
                                        <span class="metadata-label">æ ‡ç­¾ï¼š</span>
                                        <div class="tags-list">
                                            {% for tag in f.tags %}
                                            <span class="tag">{{ tag.name }}</span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="file-card-actions">
                                    <a class="file-action-btn action-detail" href="{{ url_for('file_detail', file_id=f.id) }}">è¯¦æƒ…</a>
                                    <a class="file-action-btn action-download" href="{{ url_for('download_local', stored_name=f.stored_name) }}">ä¸‹è½½</a>
                                    <!-- æ›¿æ¢æ–‡ä»¶æŒ‰é’® -->
                                    <button class="file-action-btn action-replace" data-file-id="{{ f.id }}" data-file-name="{{ f.filename }}">æ›¿æ¢</button>
                                    <form class="inline" action="{{ url_for('file_delete', file_id=f.id) }}" method="post">
                                        <button class="file-action-btn action-delete" type="submit">åˆ é™¤</button>
                                    </form>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ“</div>
                            <h3 class="empty-title">æš‚æ— æ–‡ä»¶</h3>
                            <p class="empty-desc">æ‚¨è¿˜æ²¡æœ‰ä¸Šä¼ ä»»ä½•æ–‡ä»¶</p>
                            <a href="{{ url_for('upload_page') }}" class="btn btn-primary">
                                <i class="icon-upload">ğŸ“¤</i> ä¸Šä¼ ç¬¬ä¸€ä¸ªæ–‡ä»¶
                            </a>
                        </div>
                    {% endif %}
                </section>
                
                <!-- æ”¶è—æ–‡ä»¶ -->
                <section class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">æ”¶è—æ–‡ä»¶</h2>
                    </div>
                    
                    {% if favorite_files %}
                        <div class="files-grid">
                            {% for f in favorite_files %}
                            {% set d = (f.dkfile or {}).get('data') %}
                            <div class="file-card">
                              <div class="file-card-header">
                                <div class="file-icon-container">
                                  <div class="file-icon">
                                    <div class="file-icon-top"></div>
                                    <div class="file-icon-content"></div>
                                  </div>
                                </div>
                                <div class="file-info-header">
                                  <h3 class="file-name">
                                    {% if f.filename == 'watermark-remover.html' %}
                                      å›¾ç‰‡å»æ°´å°å·¥å…·
                                    {% elif f.filename == 'subscription_manager.html' %}
                                      è®¢é˜…æœåŠ¡ç®¡ç†å™¨
                                    {% elif f.filename == 'color_mixing_game.html' %}
                                      è‰²å½©æ··åˆå¤§å¸ˆ
                                    {% elif f.filename == 'font_pairing_recommender.html' %}
                                      å­—ä½“é…å¯¹æ¨èå™¨
                                    {% else %}
                                      {{ f.filename }}
                                    {% endif %}
                                  </h3>
                                  <div class="file-size">{{ (f.size or 0) | int }} B</div>
                                </div>
                              </div>
                              <div class="file-card-body">
                                <div class="file-project">
                                  <div class="project-name">
                                    <span class="label">é¡¹ç›®åç§°ï¼š</span>
                                    <span class="value">{{ f.project_name or '-' }}</span>
                                  </div>
                                  <div class="project-desc">
                                    <span class="label">é¡¹ç›®æè¿°ï¼š</span>
                                    <span class="value">{{ f.project_desc or '-' }}</span>
                                  </div>
                                  <div class="remote-link">
                                    <span class="label">è¿œç«¯é“¾æ¥ï¼š</span>
                                    <span class="value">{% if d and d.url %}<a href="{{ d.url }}" target="_blank">æ‰“å¼€</a>{% else %}-{% endif %}</span>
                                  </div>
                                  <div class="like-count">
                                    <span class="label">ç‚¹èµæ•°ï¼š</span>
                                    <span class="value">{{ f.like_count }}</span>
                                  </div>
                                  <div class="favorite-count">
                                    <span class="label">æ”¶è—æ•°ï¼š</span>
                                    <span class="value">{{ f.favorite_count }}</span>
                                  </div>
                                  <div class="created-time">
                                    <span class="label">åˆ›å»ºæ—¶é—´ï¼š</span>
                                    <span class="value">{{ d and d.created_at or '-' }}</span>
                                  </div>
                                </div>
                              </div>
                              <div class="file-card-footer">
                                <div class="file-actions">
                                  <a class="btn btn-detail file-action" href="{{ url_for('file_detail', file_id=f.id) }}">è¯¦æƒ…</a>
                                  <a class="btn btn-download file-action" href="{{ url_for('download_local', stored_name=f.stored_name) }}">ä¸‹è½½</a>
                                  <button class="btn btn-unfavorite file-action" data-file-id="{{ f.id }}">å–æ¶ˆæ”¶è—</button>
                                </div>
                              </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <div class="empty-icon">â­</div>
                            <h3 class="empty-title">æš‚æ— æ”¶è—æ–‡ä»¶</h3>
                            <p class="empty-desc">æ‚¨è¿˜æ²¡æœ‰æ”¶è—ä»»ä½•æ–‡ä»¶ï¼Œå»é¦–é¡µæ¢ç´¢å¹¶æ”¶è—æ„Ÿå…´è¶£çš„æ–‡ä»¶å§</p>
                            <a href="{{ url_for('index') }}" class="btn btn-primary">
                                <i class="icon-explore">ğŸ”</i> å»é¦–é¡µæ¢ç´¢
                            </a>
                        </div>
                    {% endif %}
                </section>
                
                <!-- è®¿é—®è®°å½• -->
                <section class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">è®¿é—®è®°å½•</h2>
                        <button class="toggle-btn" id="toggle-logs-btn">
                            <span id="toggle-icon">â–¼</span>
                        </button>
                    </div>
                    
                    {% if access_logs %}
                        <div id="logs-container" class="logs-container">
                            <table class="logs-table">
                                <thead>
                                    <tr>
                                        <th>æ–‡ä»¶å</th>
                                        <th>æ“ä½œç±»å‹</th>
                                        <th>IPåœ°å€</th>
                                        <th>è®¿é—®æ—¶é—´</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for log in access_logs %}
                                    <tr class="log-row">
                                        <td>{{ log.filename }}</td>
                                        <td>
                                            {% if log.action == 'view' %}
                                                <span class="action-tag action-view">æŸ¥çœ‹</span>
                                            {% elif log.action == 'download' %}
                                                <span class="action-tag action-download">ä¸‹è½½</span>
                                            {% else %}
                                                <span class="action-tag action-other">{{ log.action }}</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ log.ip_address }}</td>
                                        <td>{{ log.access_time }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div id="logs-container" class="logs-container">
                            <div class="empty-state">
                                <div class="empty-icon">ğŸ“‹</div>
                                <h3 class="empty-title">æš‚æ— è®¿é—®è®°å½•</h3>
                                <p class="empty-desc">å½“æœ‰ç”¨æˆ·è®¿é—®æ‚¨çš„æ–‡ä»¶æ—¶ï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºè®¿é—®è®°å½•</p>
                            </div>
                        </div>
                    {% endif %}
                </section>
            </div>
        {% else %}
            <!-- æœªç™»å½•çŠ¶æ€ -->
            <div class="not-logged-in">
                <div class="login-prompt">
                    <div class="prompt-icon">ğŸ‘¤</div>
                    <h2 class="prompt-title">æ‚¨å°šæœªç™»å½•</h2>
                    <p class="prompt-desc">ç™»å½•åï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹å’Œç®¡ç†æ‚¨çš„æ–‡ä»¶ï¼Œäº«å—å®Œæ•´çš„æ™ºèƒ½æ–‡ä»¶ç®¡ç†ç³»ç»ŸåŠŸèƒ½</p>
                    <div class="prompt-actions">
                        <a href="{{ url_for('login') }}" class="btn btn-primary">ç™»å½•</a>
                        <a href="{{ url_for('register') }}" class="btn btn-outline">æ³¨å†Œ</a>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<link rel="stylesheet" href="{{ url_for('static', filename='user_center.css') }}">

<!-- æ›¿æ¢æ–‡ä»¶æ¨¡æ€æ¡† -->
<div id="replaceModal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <span class="modal-icon">ğŸ”„</span>
                æ›¿æ¢æ–‡ä»¶
            </h3>
            <button class="modal-close" onclick="closeReplaceModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="replaceFileForm" action="{{ url_for('file_replace') }}" method="post" enctype="multipart/form-data">
                <input type="hidden" id="replaceFileId" name="file_id">
                <div class="form-section">
                    <div class="form-group">
                        <label for="replaceFile" class="form-label">é€‰æ‹©æ–°æ–‡ä»¶</label>
                        <div class="modern-file-upload">
                            <input type="file" id="replaceFile" name="file" required class="file-input">
                            <label for="replaceFile" class="file-label">
                                <div class="upload-icon">ğŸ“</div>
                                <div class="upload-info">
                                    <span class="upload-text">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</span>
                                    <span class="upload-hint">æ”¯æŒå¤šç§æ–‡ä»¶æ ¼å¼ï¼Œå•ä¸ªæ–‡ä»¶ä¸è¶…è¿‡200MB</span>
                                    <span class="file-size"></span>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="versionComment" class="form-label">ç‰ˆæœ¬å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
                        <textarea 
                            id="versionComment" 
                            name="comment" 
                            rows="3" 
                            placeholder="è¯·è¾“å…¥ç‰ˆæœ¬æ›´æ–°è¯´æ˜ï¼Œä¾‹å¦‚ï¼šä¿®å¤äº†æŸäº›åŠŸèƒ½æˆ–æ·»åŠ äº†æ–°ç‰¹æ€§" 
                            class="form-textarea"
                        ></textarea>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-cancel" onclick="closeReplaceModal()">
                        <span class="btn-icon">âœ•</span>
                        å–æ¶ˆ
                    </button>
                    <button type="submit" class="btn btn-primary btn-submit">
                        <span class="btn-icon">ğŸš€</span>
                        æ›¿æ¢æ–‡ä»¶
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="app-data" data-is-logged-in="{{ user is not none | tojson | safe }}" class="hidden"></div>

<script src="{{ url_for('static', filename='user_center.js') }}"></script>
{% endblock %}